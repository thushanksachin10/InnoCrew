<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Logistics Agent</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .phone {
      width: 380px;
      height: 700px;
      background: #fff;
      border-radius: 40px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      border: 12px solid #111;
    }

    .header {
      background: linear-gradient(135deg, #075e54 0%, #128c7e 100%);
      color: white;
      padding: 20px;
      position: relative;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .header h2 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-dropdown {
      position: relative;
      display: inline-block;
    }

    .user-selector {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: space-between;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
    }

    .user-selector:hover {
      background: rgba(255,255,255,0.25);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      min-width: 220px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      z-index: 1000;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 10px;
      border: 1px solid #e0e0e0;
    }

    .dropdown-content.show {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-option {
      padding: 14px 16px;
      cursor: pointer;
      color: #333;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .user-option:hover {
      background: #f8f8f8;
    }

    .user-option.active {
      background: #e8f5e8;
    }

    .user-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .manager-icon { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .driver-icon { background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; }
    .customer-icon { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .user-phone {
      font-size: 12px;
      color: #666;
    }

    .notification-badge {
      background: #ff3b30;
      color: white;
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }

    .role-badge {
      background: rgba(255,255,255,0.15);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-block;
      backdrop-filter: blur(10px);
    }

    .chat {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #efeae2;
      background-image: linear-gradient(rgba(220, 220, 220, 0.1) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(220, 220, 220, 0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      max-width: 85%;
      padding: 12px 16px;
      margin: 4px 0;
      border-radius: 18px;
      font-size: 14.5px;
      white-space: pre-wrap;
      line-height: 1.5;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-msg {
      background: #dcf8c6;
      margin-left: auto;
      border-bottom-right-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }

    .bot-msg {
      background: white;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }

    .notification {
      background: #ffecb3;
      border: 1px solid #ffd54f;
      margin: 12px auto;
      max-width: 90%;
      text-align: center;
      padding: 10px 15px;
      border-radius: 15px;
      font-size: 13px;
      color: #5d4037;
      animation: pulse 2s infinite;
      font-weight: 500;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .timestamp {
      font-size: 11px;
      color: rgba(0,0,0,0.45);
      margin-top: 6px;
      text-align: right;
    }

    .options {
      background: #f0f0f0;
      border-radius: 15px;
      padding: 12px;
      margin: 8px 0;
      max-width: 90%;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .option-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px 16px;
      margin: 6px 0;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-btn:hover {
      background: #e8f5e8;
      border-color: #128c7e;
      transform: translateX(5px);
    }

    .option-btn:active {
      transform: translateX(0);
    }

    .input-box {
      display: flex;
      border-top: 1px solid #e0e0e0;
      background: #f0f0f0;
      padding: 15px;
      align-items: center;
      gap: 10px;
    }

    .input-box input {
      flex: 1;
      padding: 14px 18px;
      border: none;
      outline: none;
      font-size: 15px;
      border-radius: 25px;
      background: white;
      transition: all 0.3s;
    }

    .input-box input:focus {
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }

    .input-box button {
      padding: 14px 24px;
      background: #128c7e;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.3s;
      min-width: 90px;
    }

    .input-box button:hover {
      background: #075e54;
      transform: translateY(-2px);
    }

    .input-box button:active {
      transform: translateY(0);
    }

    /* Scrollbar styling */
    .chat::-webkit-scrollbar {
      width: 6px;
    }

    .chat::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.1);
      border-radius: 3px;
    }

    .chat::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.2);
    }
  </style>
</head>

<body>

<div class="phone">
  <div class="header">
    <div class="header-top">
      <h2>üöö Logistics Agent</h2>
      <div class="user-dropdown" id="userDropdown">
        <button class="user-selector" onclick="toggleDropdown()">
          <span id="currentUserName">üëî Manager</span>
          <span>‚ñº</span>
        </button>
        <div class="dropdown-content" id="dropdownContent">
          <div class="user-option active" onclick="selectUser('manager')">
            <div class="user-icon manager-icon">üëî</div>
            <div class="user-info">
              <div class="user-name">Manager</div>
              <div class="user-phone">+919999999999</div>
            </div>
          </div>
          <div class="user-option" onclick="selectUser('driver1')">
            <div class="user-icon driver-icon">üöõ</div>
            <div class="user-info">
              <div class="user-name">Rajesh Kumar</div>
              <div class="user-phone">+919876543210</div>
            </div>
            <div class="notification-badge">2</div>
          </div>
          <div class="user-option" onclick="selectUser('driver2')">
            <div class="user-icon driver-icon">üöõ</div>
            <div class="user-info">
              <div class="user-name">Suresh Patil</div>
              <div class="user-phone">+919876543211</div>
            </div>
          </div>
          <div class="user-option" onclick="selectUser('customer')">
            <div class="user-icon customer-icon">üì¶</div>
            <div class="user-info">
              <div class="user-name">Customer</div>
              <div class="user-phone">+918888888888</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="role-badge" id="roleBadge">Fast Logistics Pvt Ltd</div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input-box">
    <input id="message" placeholder="Type a message..." 
           onkeypress="if(event.key==='Enter')sendMessage()" />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
// User data
const users = {
  manager: {
    id: 'manager',
    name: 'üëî Manager',
    phone: '+919999999999',
    role: 'manager',
    icon: 'üëî',
    unread: 0,
    messages: [
      {
        type: 'bot',
        text: 'üëã Welcome Manager!\n\nüìã *Available Commands:*\n\n1. Plan a trip:\n   `START TRIP FROM Mumbai TO Delhi`\n\n2. Check fleet status:\n   `FLEET STATUS`\n\n3. View active trips:\n   `ACTIVE TRIPS`\n\nTry: `START TRIP FROM Pune TO Nagpur`',
        time: '11:45 AM'
      }
    ]
  },
  driver1: {
    id: 'driver1',
    name: 'üöõ Rajesh Kumar',
    phone: '+919876543210',
    role: 'driver',
    icon: 'üöõ',
    unread: 2,
    messages: [
      {
        type: 'bot',
        text: 'üëã Welcome Driver! No active trips assigned.',
        time: '10:30 AM'
      },
      {
        type: 'bot',
        text: 'üöö *New Trip Assigned!*\n\nüìç *Route:* Mumbai ‚Üí Delhi\nüìè *Distance:* 1400 km\n‚è±Ô∏è *ETA:* 25 hours\nüí∞ *Rate:* ‚Çπ12/km\n\n*Reply with:*\n1Ô∏è‚É£ START - Accept & start trip\n2Ô∏è‚É£ SHARE LOCATION\n3Ô∏è‚É£ DELAY - Report delay\n\nOr type HELP for more options.',
        time: '11:15 AM'
      }
    ]
  },
  driver2: {
    id: 'driver2',
    name: 'üöõ Suresh Patil',
    phone: '+919876543211',
    role: 'driver',
    icon: 'üöõ',
    unread: 0,
    messages: [
      {
        type: 'bot',
        text: 'üëã Welcome Driver! Your truck is currently on route from Pune to Mumbai.',
        time: '09:45 AM'
      }
    ]
  },
  customer: {
    id: 'customer',
    name: 'üì¶ Customer',
    phone: '+918888888888',
    role: 'customer',
    icon: 'üì¶',
    unread: 0,
    messages: [
      {
        type: 'bot',
        text: 'üëã Hi! I can help you book loads for transport.\n\nüì¶ *Load Booking Service:*\n\n*Format:*\n`LOAD <weight>kg <pickup> to <dropoff>`\n\n*Examples:*\n‚Ä¢ `LOAD 500kg Mumbai to Pune`\n‚Ä¢ `LOAD 1000kg Delhi to Jaipur`\n‚Ä¢ `LOAD 300kg Bangalore to Chennai`\n\nType HELP for more options.',
        time: '09:30 AM'
      }
    ]
  }
};

// Role-based quick replies
const quickReplies = {
  manager: [],
  driver1: [
    { emoji: '1Ô∏è‚É£', text: 'START', command: '1Ô∏è‚É£ START' },
    { emoji: '2Ô∏è‚É£', text: 'SHARE LOCATION', command: '2Ô∏è‚É£ SHARE LOCATION' },
    { emoji: '3Ô∏è‚É£', text: 'DELAY', command: '3Ô∏è‚É£ DELAY' },
    { emoji: '‚úÖ', text: 'ARRIVED', command: 'ARRIVED' },
    { emoji: '‚ùì', text: 'HELP', command: 'HELP' }
  ],
  driver2: [
    { emoji: '1Ô∏è‚É£', text: 'START', command: '1Ô∏è‚É£ START' },
    { emoji: '2Ô∏è‚É£', text: 'SHARE LOCATION', command: '2Ô∏è‚É£ SHARE LOCATION' },
    { emoji: '3Ô∏è‚É£', text: 'DELAY', command: '3Ô∏è‚É£ DELAY' },
    { emoji: '‚úÖ', text: 'ARRIVED', command: 'ARRIVED' },
    { emoji: '‚ùì', text: 'HELP', command: 'HELP' }
  ],
  customer: [
    { emoji: 'üì¶', text: 'LOAD 500kg Mumbai to Pune', command: 'LOAD 500kg Mumbai to Pune' },
    { emoji: 'üì¶', text: 'LOAD 1000kg Delhi to Jaipur', command: 'LOAD 1000kg Delhi to Jaipur' },
    { emoji: 'üìç', text: 'CHECK STATUS', command: 'CHECK STATUS' },
    { emoji: '‚ùì', text: 'HELP', command: 'HELP' }
  ]
};

let currentUser = 'manager';

function toggleDropdown() {
  const dropdown = document.getElementById('dropdownContent');
  dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('userDropdown');
  if (!dropdown.contains(event.target)) {
    const dropdownContent = document.getElementById('dropdownContent');
    dropdownContent.classList.remove('show');
  }
});

function selectUser(userId) {
  toggleDropdown();
  
  // Update dropdown active state
  document.querySelectorAll('.user-option').forEach(option => {
    option.classList.remove('active');
  });
  document.querySelector(`.user-option[onclick*="${userId}"]`).classList.add('active');
  
  // Switch user
  switchUser(userId);
}

function switchUser(userId) {
  const user = users[userId];
  
  // Reset unread for this user
  user.unread = 0;
  
  // Update UI
  currentUser = userId;
  document.getElementById('currentUserName').textContent = user.name;
  document.getElementById('roleBadge').textContent = `${user.role.charAt(0).toUpperCase() + user.role.slice(1)} - Fast Logistics`;
  
  // Remove notification badge for this user
  const badge = document.querySelector(`.user-option[onclick*="${userId}"] .notification-badge`);
  if (badge) {
    badge.remove();
  }
  
  // Load user's messages
  loadUserMessages();
  
  // Add system notification
  const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  const chat = document.getElementById('chat');
  chat.innerHTML += `
    <div class="notification">
      üîÑ Switched to ${user.role} mode
    </div>
  `;
  
  chat.scrollTop = chat.scrollHeight;
}

function loadUserMessages() {
  const chat = document.getElementById('chat');
  const user = users[currentUser];
  
  chat.innerHTML = '';
  
  // Add user's message history
  user.messages.forEach(msg => {
    const msgClass = msg.type === 'user' ? 'user-msg' : 'bot-msg';
    chat.innerHTML += `
      <div class="msg ${msgClass}">
        ${escapeHtml(msg.text)}
        <div class="timestamp">${msg.time}</div>
      </div>
    `;
  });
  
  // Show quick reply options for current user
  showQuickReplies();
}

function showQuickReplies() {
  const chat = document.getElementById('chat');
  const replies = quickReplies[currentUser];
  
  if (replies && replies.length > 0) {
    let optionsHtml = '<div class="options">';
    replies.forEach(reply => {
      optionsHtml += `
        <button class="option-btn" onclick="sendQuickReply('${reply.command}')">
          <span style="font-size: 16px;">${reply.emoji}</span>
          ${reply.text}
        </button>
      `;
    });
    optionsHtml += '</div>';
    chat.innerHTML += optionsHtml;
  }
  
  chat.scrollTop = chat.scrollHeight;
}

function sendQuickReply(command) {
  document.getElementById('message').value = command;
  sendMessage();
}

async function sendMessage() {
  const input = document.getElementById('message');
  const text = input.value.trim();
  if (!text) return;

  const chat = document.getElementById('chat');
  const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

  // Add user message
  chat.innerHTML += `
    <div class="msg user-msg">
      ${escapeHtml(text)}
      <div class="timestamp">${now}</div>
    </div>
  `;
  
  // Save message to user's history
  users[currentUser].messages.push({
    type: 'user',
    text: text,
    time: now
  });
  
  // Simulate notifications to other users
  if (currentUser === 'manager' && text.startsWith('START TRIP FROM')) {
    // Parse the trip info
    const match = text.match(/START TRIP FROM (.+?) TO (.+)/i);
    if (match) {
      const origin = match[1];
      const destination = match[2];
      
      // Notify driver1
      users.driver1.messages.push({
        type: 'bot',
        text: `üöö *New Trip Assigned!*\n\nüìç *Route:* ${origin} ‚Üí ${destination}\nüìè *Distance:* 1400 km (approx)\n‚è±Ô∏è *ETA:* 25 hours\nüí∞ *Rate:* ‚Çπ12/km\n\n*Reply with:*\n1Ô∏è‚É£ START - Accept & start trip\n2Ô∏è‚É£ SHARE LOCATION\n3Ô∏è‚É£ DELAY - Report delay`,
        time: now
      });
      users.driver1.unread = 1;
      
      // Update notification badge
      const driverOption = document.querySelector('.user-option[onclick*="driver1"]');
      if (!driverOption.querySelector('.notification-badge')) {
        const badge = document.createElement('div');
        badge.className = 'notification-badge';
        badge.textContent = '1';
        driverOption.appendChild(badge);
      }
    }
  }
  
  input.value = "";

  // Send to backend
  try {
    const user = users[currentUser];
    const res = await fetch("/message", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `message=${encodeURIComponent(text)}&phone=${encodeURIComponent(user.phone)}`
    });

    const data = await res.json();

    // Add bot reply
    chat.innerHTML += `
      <div class="msg bot-msg">
        ${escapeHtml(data.reply)}
        <div class="timestamp">${now}</div>
      </div>
    `;
    
    // Save bot message to history
    users[currentUser].messages.push({
      type: 'bot',
      text: data.reply,
      time: now
    });
    
    // Show quick replies again after bot response
    setTimeout(() => {
      showQuickReplies();
    }, 300);
    
  } catch (error) {
    chat.innerHTML += `
      <div class="msg bot-msg">
        ‚ùå Error: Could not connect to server. Please try again.
        <div class="timestamp">${now}</div>
      </div>
    `;
  }
  
  chat.scrollTop = chat.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML.replace(/\n/g, '<br>');
}

// Initialize
window.onload = () => {
  loadUserMessages();
  
  // Add click outside to close dropdown
  document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('dropdownContent');
    if (!event.target.closest('.user-dropdown')) {
      dropdown.classList.remove('show');
    }
  });
};
</script>

</body>
</html>